<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>aL vaLe â€” Shop</title>
  <link rel="icon" type="image/png" href="/images/vale-logo-removebg-preview.png">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Feather icons -->
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

  <!-- Snipcart (cart) -->
  <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.3.0/default/snipcart.css" />
  <script async src="https://cdn.snipcart.com/themes/v3.3.0/default/snipcart.js"></script>

  <style>
    /* ---------- local fonts & base ---------- */
    @font-face {
      font-family: 'Plunct';
      src: url('/fonts/Plunct.woff2') format('woff2'),
           url('/fonts/Plunct.woff') format('woff'),
           url('/fonts/Plunct.otf') format('opentype');
      font-display: swap;
      font-weight: 400;
      font-style: normal;
    }

    /* small utilities and theme variables */
    :root { --gold:#D4AF37; --black:#000; --white:#fff; --accent:#facc15; }
    html, body { height: 100%; margin: 0; font-family: 'Plunct', system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; color: #111; background: #fff; }
    .plunct { font-family: 'Plunct', sans-serif; font-weight:700; }
    .monument { font-weight:700; }
    .bag-count{ font-family: "Plunct",sans-serif; font-weight:900; font-size:11px; line-height:1; }

    /* Header / nav styling */
    header, nav { background: #fff; }
    .header-actions{ display:flex; align-items:center; justify-content:flex-end; gap:10px; width:auto; }
    .search-wrap { position:relative; display:inline-flex; align-items:center; gap:8px; }
    .search-input {
      position: absolute;
      right: 44px;
      width: 0;
      opacity: 0;
      transition: width .22s cubic-bezier(.2,.9,.3,1), opacity .18s ease;
      border:1px solid rgba(0,0,0,0.08);
      padding:8px 10px;
      border-radius:8px;
      font-size:0.95rem;
      outline:none;
      background:#fff;
      color:var(--black);
      transform-origin: right center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
      z-index: 60;
      white-space:nowrap;
    }
    .search-wrap.open .search-input { width: 220px; opacity: 1; }
    .search-btn { width:36px; height:36px; display:flex; align-items:center; justify-content:center; border-radius:8px; background:transparent; border:none; cursor:pointer; padding:0; z-index: 65; }

    /* Hero */
    .shop-hero {
      position: relative;
      background-image: url('/images/avale-banner.gif');
      background-size: cover;
      background-position: center;
      color:#fff;
      padding-top:6rem;
      padding-bottom:6rem;
      min-height:36vh;
      display:flex;
      align-items:center;
    }
    .shop-hero .overlay{ position:absolute; inset:0; background:rgba(0,0,0,0.32); pointer-events:none; }

    /* Filter panel */
    .filter-panel{ position:sticky; top:96px; max-height:calc(100vh - 110px); overflow:auto; padding-right:8px; }
    .filter-panel .subtype-heading{ margin-top:8px; font-weight:700; color:var(--black); margin-bottom:4px; }
    .filter-section + .filter-section { margin-top: 12px; }
    .subtype-group { display:block; margin:6px 0; color:var(--black); }

    .product-card{ border:1px solid rgba(0,0,0,0.06); box-shadow:0 6px 18px rgba(0,0,0,0.04); transition:transform .18s ease, box-shadow .18s ease; background:white; }
    .product-card:hover{ transform:translateY(-6px); box-shadow:0 14px 30px rgba(0,0,0,0.06); }

    .badge-gold{ background:var(--gold); color:#000; font-weight:900; padding:4px 8px; border-radius:6px; font-size:11px; }

    .subtype-link { display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; background:#fff; border:1px solid rgba(0,0,0,0.04); }
    .subtype-badge { background:rgba(0,0,0,0.06); padding:2px 8px; border-radius:9999px; font-size:12px; }

    .nav-btn { transition: all .12s ease; display:flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); background:transparent; cursor:pointer; }
    .heart-btn{ background:rgba(255,255,255,0.85); border-radius:9999px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; }
    .heart-active{ background:var(--gold); color:#000 !important; }

    .share-btn{ background:transparent; border:none; width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; }

    /* responsive grid */
    .curated-grid { display:grid; grid-template-columns: repeat(3,1fr); gap:1rem; }
    @media (max-width:1024px){ .curated-grid { grid-template-columns: repeat(2,1fr); } }
    @media (max-width:640px){ .curated-grid { grid-template-columns: 1fr; } }

    /* small utilities */
    .applied-pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid rgba(0,0,0,0.06); font-size:13px; }
    .pill-close { background:transparent; border:none; font-size:16px; line-height:1; padding:2px 6px; cursor:pointer; }
    .share-toast { position:fixed; bottom:18px; right:18px; background:#111; color:#fff; padding:8px 12px; border-radius:8px; font-size:13px; opacity:0.92; z-index:99999; }

    /* small accessibility focus */
    .menu-trigger:focus, .search-btn:focus, .nav-btn:focus, .pill-close:focus { outline: 2px solid rgba(250,204,21,0.25); outline-offset:2px; border-radius:6px; }
  </style>
</head>
<body class="site-overlay site-content">

  <!-- HEADER / NAV (aL vaLe branding + search / favorites / cart) -->
  <header id="siteHeader" class="fixed w-full z-50 bg-white shadow">
    <nav class="container mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4 min-w-0">
        <!-- Mobile hamburger -->
        <button id="mobileMenuBtn" aria-label="Open menu" class="md:hidden p-2">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18M3 12h18M3 17h18"></path></svg>
        </button>

        <!-- logo + brand -->
        <a href="/SHOP/" class="flex items-center gap-3">
          <img id="valeLogo" src="/images/vale-logo-removebg-preview.png" alt="vaLe" class="w-10 h-10 object-contain">
          <span class="plunct text-2xl" style="font-weight:800; color:var(--black);">aL vaLe</span>
        </a>

        <!-- desktop links -->
        <div class="hidden md:flex space-x-6 ml-6">
          <a href="/HOME/" class="monument hover:text-yellow-500">HOME</a>
          <a href="/MUSIC/" class="monument hover:text-yellow-500">MUSIC</a>
          <a href="/SHOP/" class="monument hover:text-yellow-500">SHOP</a>
          <a href="/CONTACT/" class="monument hover:text-yellow-500">CONTACT</a>
        </div>
      </div>

      <!-- actions: search, favorites, cart -->
      <div class="header-actions">
        <div class="search-wrap" id="desktopSearchWrap" aria-hidden="false">
          <form id="headerSearchForm" class="search-form" role="search" action="/search.html" method="get">
            <input id="headerSearchInput" name="q" type="search" class="search-input" placeholder="Search products..." aria-label="Search products">
            <button id="headerSearchBtn" type="submit" class="search-btn" aria-label="Search">
              <i data-feather="search" class="w-4 h-4"></i>
            </button>
          </form>
        </div>

        <a href="/favorites.html" id="headerFavorites" class="text-black flex items-center justify-center" aria-label="Favorites" title="Favorites">
          <i data-feather="heart" class="w-5 h-5"></i>
        </a>

        <a href="#" id="headerCartToggle" class="relative snipcart-checkout text-black nav-btn" aria-label="Cart" title="Cart">
          <i data-feather="shopping-bag" class="w-5 h-5"></i>
          <span class="absolute -top-2 -right-2 bg-amber-600 text-black text-xs rounded-full w-5 h-5 flex items-center justify-center bag-count">
            <span class="snipcart-items-count">0</span>
          </span>
        </a>
      </div>
    </nav>

    <!-- mobile nav -->
    <div id="mobileNav" class="md:hidden" style="display:none;">
      <div class="flex items-center justify-between mb-4 px-4 py-3 bg-black/80">
        <div class="flex items-center gap-3">
          <img src="/images/vale-logo-removebg-preview.png" alt="vaLe" class="w-8 h-8 object-contain">
          <span class="plunct text-lg" style="color:var(--white);">aL vaLe</span>
        </div>
        <button id="mobileCloseBtn" class="p-2" title="Close menu"><i data-feather="x"></i></button>
      </div>

      <div id="mobileSearchBar" class="px-4 py-3" aria-hidden="true">
        <form id="mobileSearchForm" action="/search.html" method="get" role="search">
          <input id="mobileSearchInput" name="q" type="search" placeholder="Search products..." aria-label="Search products" class="w-full p-2 rounded border">
          <button type="submit" class="mt-2 w-full bg-amber-600 text-black px-3 py-2 rounded plunct">Search</button>
        </form>
      </div>

      <div class="space-y-3 pl-4 pb-6">
        <a href="/HOME/" class="block py-2 border-b">HOME</a>
        <a href="/MUSIC/" class="block py-2 border-b">MUSIC</a>
        <a href="/SHOP/" class="block py-2 border-b">SHOP</a>
        <a href="/CONTACT/" class="block py-2 border-b">CONTACT</a>
        <a href="/favorites.html" class="block py-2 border-b">Favorites</a>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="shop-hero text-white mt-20">
    <div class="overlay" aria-hidden="true"></div>
    <div class="container mx-auto px-6 hero-inner">
      <div class="shop-banner max-w-3xl">
        <h1 class="plunct text-5xl md:text-6xl mb-4" style="font-weight:800;">aL vaLe Merch</h1>
        <div class="flex items-center text-gray-200 text-sm plunct">
          <a href="/HOME/" class="hover:text-white text-gray-200">Home</a>
          <i data-feather="chevron-right" class="mx-2 w-4 h-4"></i>
          <span>Shop</span>
        </div>
        <p class="mt-4 text-lg plunct opacity-90">Official merch, signed drops & limited runs.</p>
      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <section class="py-12">
    <div class="container mx-auto px-6">
      <div class="flex flex-col md:flex-row gap-8">
        <aside class="md:w-1/4">
          <div class="bg-white p-6 rounded-lg filter-panel plunct">
            <h3 class="font-medium text-lg mb-4" style="color:var(--black);">Filter</h3>

            <!-- Category (focused for merch) -->
            <div class="filter-section">
              <button class="filter-toggle" data-target="category-body">
                <span style="color:var(--black);">Category</span>
                <i data-feather="chevron-down" class="chev"></i>
              </button>
              <div id="category-body" class="mt-3">
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="checkbox" id="cat-avale" value="aL vaLe" class="filter-cat mr-2">
                    <label for="cat-avale" class="text-sm" style="color:var(--black);">aL vaLe (Official Merch)</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="cat-veerwear" value="Veerwear" class="filter-cat mr-2">
                    <label for="cat-veerwear" class="text-sm" style="color:var(--black);">Veerwear</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="cat-accessories" value="Accessories" class="filter-cat mr-2">
                    <label for="cat-accessories" class="text-sm" style="color:var(--black);">Accessories</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Subtype (merch-focused) -->
            <div class="filter-section mt-4">
              <button class="filter-toggle" data-target="subtype-body">
                <span style="color:var(--black);">Product type</span>
                <i data-feather="chevron-down" class="chev"></i>
              </button>
              <div id="subtype-body" class="mt-3">
                <div class="subtype-heading">Merch</div>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Tees"> Tees</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Hoodies"> Hoodies</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Hats"> Hats</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Stickers"> Stickers</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Posters"> Posters</label>
              </div>
            </div>

            <!-- Features / Technique -->
            <div class="filter-section mt-4">
              <button class="filter-toggle" data-target="feature-body">
                <span style="color:var(--black);">Features</span>
                <i data-feather="chevron-down" class="chev"></i>
              </button>
              <div id="feature-body" class="mt-3">
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="checkbox" id="feat-screen" value="Screenprint" class="filter-tech mr-2">
                    <label for="feat-screen" class="text-sm" style="color:var(--black);">Screenprint</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="feat-embroider" value="Embroidered" class="filter-tech mr-2">
                    <label for="feat-embroider" class="text-sm" style="color:var(--black);">Embroidered</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="feat-limited" value="Limited" class="filter-tech mr-2">
                    <label for="feat-limited" class="text-sm" style="color:var(--black);">Limited Edition</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Materials tuned for merch -->
            <div class="filter-section mt-4">
              <button class="filter-toggle" data-target="material-body">
                <span style="color:var(--black);">Material</span>
                <i data-feather="chevron-down" class="chev"></i>
              </button>
              <div id="material-body" class="mt-3">
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="checkbox" id="mat-cotton" value="Cotton" class="filter-material mr-2">
                    <label for="mat-cotton" class="text-sm" style="color:var(--black);">Cotton</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="mat-poly" value="Poly Blend" class="filter-material mr-2">
                    <label for="mat-poly" class="text-sm" style="color:var(--black);">Poly Blend</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="mat-resin" value="Resin" class="filter-material mr-2">
                    <label for="mat-resin" class="text-sm" style="color:var(--black);">Resin</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="mat-paper" value="Paper" class="filter-material mr-2">
                    <label for="mat-paper" class="text-sm" style="color:var(--black);">Paper (Posters)</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Price ranges tailored to merch -->
            <div class="filter-section mt-4">
              <button class="filter-toggle" data-target="price-body">
                <span style="color:var(--black);">Price Range</span>
                <i data-feather="chevron-down" class="chev"></i>
              </button>
              <div id="price-body" class="mt-3">
                <div class="space-y-2">
                  <div class="flex items-center"><input type="radio" id="price-all" name="price" value="all" checked class="filter-price mr-2"><label for="price-all" class="text-sm">All Prices</label></div>
                  <div class="flex items-center"><input type="radio" id="price-1" name="price" value="under25" class="filter-price mr-2"><label for="price-1" class="text-sm">Under $25</label></div>
                  <div class="flex items-center"><input type="radio" id="price-2" name="price" value="25-50" class="filter-price mr-2"><label for="price-2" class="text-sm">$25 - $50</label></div>
                  <div class="flex items-center"><input type="radio" id="price-3" name="price" value="50-150" class="filter-price mr-2"><label for="price-3" class="text-sm">$50 - $150</label></div>
                  <div class="flex items-center"><input type="radio" id="price-4" name="price" value="over150" class="filter-price mr-2"><label for="price-4" class="text-sm">Over $150</label></div>
                </div>
              </div>
            </div>

            <button id="applyFiltersBtn" class="w-full bg-amber-600 hover:bg-amber-700 text-black py-2 rounded-md plunct mt-4">Apply Filters</button>
          </div>
        </aside>

        <main class="md:w-3/4 plunct">
          <div class="flex justify-between items-center mb-6">
            <div>
              <span id="showingText" style="color:var(--black);">Showing 0 of 0 products</span>
              <div id="appliedFiltersWrap" style="display:inline-block; margin-left:12px; vertical-align:middle;"></div>
            </div>

            <div class="flex items-baseline sort-row">
              <span class="mr-2 text-gray-600 text-sm" style="color:var(--black);">Sort by:</span>
              <div class="select-with-icon">
                <i data-feather="chevron-down" class="w-4 h-4"></i>
                <select id="sortSelect" class="text-black rounded-md text-sm">
                  <option value="featured">Featured</option>
                  <option value="price-asc">Price: Low to High</option>
                  <option value="price-desc">Price: High to Low</option>
                  <option value="newest">Newest Arrivals</option>
                  <option value="best-selling">Best Selling</option>
                </select>
              </div>
            </div>
          </div>

          <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

          <div class="flex justify-center mt-12"><nav id="pagination" class="flex items-center space-x-2"></nav></div>
        </main>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="py-12">
    <div class="container mx-auto px-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h3 class="plunct text-xl mb-4" style="font-weight:900;">aL vaLe</h3>
          <p class="mb-4">Official merchandise & limited drops. All designs and drops are authorized by aL vaLe.</p>
        </div>
        <div>
          <h4 class="plunct font-medium mb-4">Shop</h4>
          <ul class="space-y-2">
            <li><a href="/SHOP/" class="text-sm">All Products</a></li>
            <li><a href="/SHOP/?category=aLvaLemerCh" class="text-sm">aL vaLe Merch</a></li>
            <li><a href="/SHOP/?category=Veerwear" class="text-sm">Veerwear</a></li>
            <li><a href="/SHOP/?category=Accessories" class="text-sm">Accessories</a></li>
          </ul>
        </div>
        <div>
          <h4 class="plunct font-medium mb-4">Support</h4>
          <ul class="space-y-2">
            <li><a href="/HowToOrder/" class="text-sm">How to Order</a></li>
            <li><a href="/contact/" class="text-sm">Contact</a></li>
          </ul>
        </div>
        <div>
          <h4 class="plunct font-medium mb-4">Legal</h4>
          <ul class="space-y-2">
            <li><a href="/TermsandConditions/" class="text-sm">Terms & Conditions</a></li>
          </ul>
        </div>
      </div>
      <div class="border-t mt-12 pt-8 text-center text-sm" style="border-color:#111;">
        <p>Â© 2025 aL vaLe. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Snipcart root (replace with your API key) -->
  <div hidden id="snipcart" data-api-key="YOUR_SNIPCART_API_KEY"></div>

  <!-- Scripts (search, filters, products, favorites, cart) -->
  <script>
    feather.replace();

    // Mobile nav toggle
    const mobileBtn = document.getElementById('mobileMenuBtn');
    const mobileNav = document.getElementById('mobileNav');
    const mobileClose = document.getElementById('mobileCloseBtn');
    mobileBtn?.addEventListener('click', ()=> {
      mobileNav.style.display='block';
      document.body.classList.remove('mobile-search-open');
    });
    mobileClose?.addEventListener('click', ()=> {
      mobileNav.style.display='none';
      const mIn = document.getElementById('mobileSearchInput');
      if(mIn) mIn.value = '';
      document.body.classList.remove('mobile-search-open');
    });

    // Filter collapse behavior (chevrons)
    document.querySelectorAll('.filter-toggle').forEach(btn=>{
      const target = document.getElementById(btn.getAttribute('data-target'));
      const chev = btn.querySelector('.chev');
      if(target) target.style.display='block';
      if(chev) chev.classList.add('open');
      btn.addEventListener('click', ()=>{
        if(!target) return;
        const none = getComputedStyle(target).display === 'none';
        target.style.display = none ? 'block' : 'none';
        chev?.classList.toggle('open', none);
      });
    });

    /* --------------------------
       Subtypes / materials for aL vaLe merch
    -------------------------- */
    const subtypesMap = {
      'aL vaLe': ['Tees','Hoodies','Hats','Stickers','Posters'],
      'Veerwear': ['Apparel','Accessories'],
      'Accessories': ['Pins','Keychains','Bags']
    };

    const displayToSlug = {
      'Tees':'tees','Hoodies':'hoodies','Hats':'hats','Stickers':'stickers','Posters':'posters',
      'Apparel':'apparel','Accessories':'accessories','Pins':'pins','Keychains':'keychains','Bags':'bags'
    };

    const slugToDisplay = {};
    Object.keys(displayToSlug).forEach(k => { slugToDisplay[displayToSlug[k]] = k; });

    function techniqueFromSubtype(sub) {
      if(!sub) return '';
      const s = sub.toLowerCase();
      if(s.includes('tee') || s.includes('hoodie')) return 'Apparel';
      if(s.includes('sticker') || s.includes('poster')) return 'Print';
      return '';
    }

    function normalizeSlugInput(raw){
      if(!raw) return '';
      let s = String(raw).trim().toLowerCase();
      s = s.replace(/[%20\+_]+/g,'-');
      s = s.replace(/[^\w-]+/g,'-');
      s = s.replace(/-+/g,'-');
      s = s.replace(/^-|-$/g,'');
      return s;
    }
    function slugToLabel(rawSlug){
      const norm = normalizeSlugInput(rawSlug);
      if(!norm) return null;
      if(slugToDisplay[norm]) return slugToDisplay[norm];
      return null;
    }

    /* --------------------------
       Product generator (demo) - tuned for merch price ranges
    -------------------------- */
    const categories = ['aL vaLe','Veerwear','Accessories'];
    const materials = ['Cotton','Poly Blend','Resin','Paper','Embroidered'];
    const products = [];
    const TOTAL_ITEMS = 72;
    function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function buildDemoProducts(){
      products.length = 0;
      for(let i=1;i<=TOTAL_ITEMS;i++){
        const cat = categories[i % categories.length];
        const mat = materials[i % materials.length];
        // make merch prices realistic
        let price;
        if(mat === 'Paper') price = rand(8,35);
        else if(cat === 'aL vaLe') price = rand(18,120);
        else price = rand(12,90);
        const sold = rand(0,2000);
        const featured = i % 7 === 0;
        const date = new Date(Date.now() - rand(0,365)*24*3600*1000).toISOString();

        const pool = subtypesMap[cat] || ['Misc'];
        const subtype = pool[rand(0, pool.length-1)];
        const technique = techniqueFromSubtype(subtype) || (Math.random() < 0.1 ? 'Limited' : '');

        products.push({
          id:i,
          title:`${subtype} ${i}`,
          description:`${mat} Â· ${cat} Â· ${subtype}`,
          image:`/images/placeholder-${(i%10)+1}.jpg`,
          price,
          category:cat,
          material:mat,
          subtype,
          technique,
          soldCount:sold,
          featured,
          date
        });
      }
    }

    // State
    let currentPage = 1;
    const pageSize = 24;
    let currentFilters = { categories:[], materials:[], price:'all', subtypes:[], techniques:[] };
    let currentSort = 'featured';

    // favorites
    function readFavorites(){ try{ return new Set(JSON.parse(localStorage.getItem('sb_favorites')||'[]')); }catch(e){ return new Set(); } }
    function writeFavorites(set){ const arr = Array.from(set); localStorage.setItem('sb_favorites', JSON.stringify(arr)); }
    function toggleFavorite(id){ const s = readFavorites(); if(s.has(id)) s.delete(id); else s.add(id); writeFavorites(s); renderProducts(); }

    function priceMatch(price, filterKey){
      if(!filterKey||filterKey==='all') return true;
      if(filterKey==='under25') return price < 25;
      if(filterKey==='25-50') return price >=25 && price <=50;
      if(filterKey==='50-150') return price >50 && price <=150;
      if(filterKey==='over150') return price >150;
      return true;
    }

    function applyFiltersAndSort(){
      let out = products.slice();

      if(currentFilters.categories.length) out = out.filter(p => currentFilters.categories.includes(p.category));
      if(currentFilters.materials.length) out = out.filter(p => currentFilters.materials.includes(p.material));
      if(currentFilters.subtypes.length) out = out.filter(p => currentFilters.subtypes.includes(p.subtype));
      if(currentFilters.techniques.length) out = out.filter(p => currentFilters.techniques.includes(p.technique));
      if(currentFilters.price && currentFilters.price !== 'all') out = out.filter(p => priceMatch(p.price, currentFilters.price));

      if(currentSort==='price-asc') out.sort((a,b)=>a.price-b.price);
      else if(currentSort==='price-desc') out.sort((a,b)=>b.price-a.price);
      else if(currentSort==='newest') out.sort((a,b)=>new Date(b.date)-new Date(a.date));
      else if(currentSort==='best-selling') out.sort((a,b)=>b.soldCount-a.soldCount);
      else out.sort((a,b)=> (b.featured?1:0) - (a.featured?1:0));

      return out;
    }

    function renderProducts(){
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';
      const filtered = applyFiltersAndSort();
      const total = filtered.length;
      const start = (currentPage-1)*pageSize;
      const pageItems = filtered.slice(start, start + pageSize);
      document.getElementById('showingText').textContent = `Showing ${pageItems.length} of ${total} products`;
      const favSet = readFavorites();

      for(const p of pageItems){
        let fontClass = 'plunct';
        const heartActive = favSet.has(p.id);

        const card = document.createElement('div');
        card.className = 'product-card rounded-lg overflow-hidden';
        card.innerHTML = `
          <div class="relative overflow-hidden h-64">
            <img src="${p.image}" alt="${p.title}" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"></div>
            ${p.featured ? `<div class="absolute top-3 left-3 badge-gold">BESTSELLER</div>` : ''}
            <button class="absolute top-3 right-3 heart-btn ${heartActive ? 'heart-active' : ''}" data-id="${p.id}" title="Save to favorites">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="${heartActive ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>
            </button>
          </div>
          <div class="p-4">
            <h3 class="font-medium mb-1 ${fontClass}" style="color:var(--black);">${p.title}</h3>
            <p class="${fontClass} text-gray-600 text-sm mb-2" style="color:var(--black);">${p.description}</p>
            <div class="flex justify-between items-center">
              <span class="${fontClass} font-bold" style="color:var(--black);">$${p.price.toLocaleString()}</span>

              <button class="snipcart-add-item inline-flex items-center px-3 py-2 rounded text-sm border border-transparent bg-amber-600 hover:bg-amber-700"
                data-item-id="${p.id}"
                data-item-name="${p.title}"
                data-item-price="${p.price}"
                data-item-url="/SHOP/"
                data-item-description="${p.description}"
                data-item-image="${p.image}">
                Add to cart
              </button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      }

      // bind heart toggles
      document.querySelectorAll('.heart-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = Number(btn.getAttribute('data-id'));
          toggleFavorite(id);
        });
      });

      feather.replace();
      renderPagination(filtered.length);
    }

    function renderPagination(totalFiltered){
      const pagination = document.getElementById('pagination'); pagination.innerHTML='';
      const totalPages = Math.max(1, Math.ceil(totalFiltered / pageSize));

      function makeNavButton(iconName, onClick, disabled=false){
        const b = document.createElement('button');
        b.className = 'nav-btn';
        if(disabled) b.setAttribute('disabled','true');
        b.innerHTML = `<i data-feather="${iconName}" class="w-4 h-4"></i>`;
        b.addEventListener('click', (e)=>{ if(disabled) return; b.classList.add('clicked'); setTimeout(()=>b.classList.remove('clicked'),140); onClick(e); });
        pagination.appendChild(b);
        return b;
      }

      makeNavButton('chevron-left', ()=>{
        if(currentPage > 1){ currentPage--; renderProducts(); }
      }, currentPage === 1);

      function pageBtn(page){
        const b = document.createElement('button');
        b.className = 'page-btn';
        b.textContent = String(page);
        if(page === currentPage) b.classList.add('page-active');
        b.addEventListener('click', ()=>{
          if(page === currentPage) {
            b.classList.add('clicked');
            setTimeout(()=>b.classList.remove('clicked'),120);
            return;
          }
          b.classList.add('clicked');
          setTimeout(()=>b.classList.remove('clicked'),120);
          currentPage = page;
          renderProducts();
        });
        pagination.appendChild(b);
      }

      if(totalPages <= 8){
        for(let p=1;p<=totalPages;p++) pageBtn(p);
      } else {
        pageBtn(1);
        pageBtn(2);
        const start = Math.max(3, Math.min(currentPage-1, totalPages-4));
        const end = Math.min(totalPages-2, start + 2);
        if(currentPage > 4){
          const dots = document.createElement('span'); dots.className='px-2'; dots.textContent='...'; pagination.appendChild(dots);
        }
        for(let p=start;p<=end;p++) pageBtn(p);
        if(end < totalPages-2){
          const dots2 = document.createElement('span'); dots2.className='px-2'; dots2.textContent='...'; pagination.appendChild(dots2);
        }
        pageBtn(totalPages-1);
        pageBtn(totalPages);
      }

      makeNavButton('chevron-right', ()=>{
        if(currentPage < Math.ceil(totalFiltered / pageSize)){ currentPage++; renderProducts(); }
      }, currentPage === Math.ceil(totalFiltered / pageSize));

      feather.replace();
    }

    // Read filters from UI into state
    function readFiltersFromUI(){
      currentFilters.categories = Array.from(document.querySelectorAll('.filter-cat:checked')).map(i=>i.value);
      currentFilters.materials = Array.from(document.querySelectorAll('.filter-material:checked')).map(i=>i.value);
      currentFilters.subtypes = Array.from(document.querySelectorAll('.filter-subtype:checked')).map(i=>i.value);
      currentFilters.techniques = Array.from(document.querySelectorAll('.filter-tech:checked')).map(i=>i.value);
      const priceRadio = document.querySelector('.filter-price:checked');
      currentFilters.price = priceRadio ? priceRadio.value : 'all';
      updateAppliedFiltersPill();
    }

    document.getElementById('applyFiltersBtn').addEventListener('click', ()=>{ readFiltersFromUI(); currentPage = 1; renderProducts(); });
    document.getElementById('sortSelect').addEventListener('change', e => { currentSort = e.target.value; currentPage = 1; renderProducts(); });

    /* --------------------------
       Cart behaviour using Snipcart API (toggle)
    -------------------------- */
    const headerCartToggle = document.getElementById('headerCartToggle');
    let cartOpen = false;
    document.addEventListener('snipcart.ready', ()=>{ cartOpen = false; });
    document.addEventListener('snipcart.opened', ()=>{ cartOpen = true; });
    document.addEventListener('snipcart.closed', ()=>{ cartOpen = false; });

    headerCartToggle?.addEventListener('click', (e)=>{
      e.preventDefault();
      headerCartToggle.classList.add('clicked');
      setTimeout(()=> headerCartToggle.classList.remove('clicked'), 140);

      if(window.Snipcart && window.Snipcart.api && window.Snipcart.api.modal){
        if(cartOpen) window.Snipcart.api.modal.close();
        else window.Snipcart.api.modal.open();
      } else {
        const anchor = document.querySelector('a.snipcart-checkout');
        if(anchor){ anchor.click(); } else { console.warn('Snipcart not initialized yet.'); }
      }
    });

    /* --------------------------
       SEARCH UX (desktop & mobile)
    -------------------------- */
    function initHeaderSearch(){
      const wrap = document.getElementById('desktopSearchWrap');
      const form = document.getElementById('headerSearchForm');
      const input = document.getElementById('headerSearchInput');
      const btn = document.getElementById('headerSearchBtn');

      if(!wrap || !form || !input || !btn) return;

      function isMobile() { return window.matchMedia('(max-width:767px)').matches; }

      btn.addEventListener('click', (ev) => {
        if (isMobile()) {
          openMobileSearchAndFocus();
          ev.preventDefault();
          return;
        }
        const isOpen = wrap.classList.contains('open');
        if(!isOpen) {
          ev.preventDefault();
          wrap.classList.add('open');
          setTimeout(()=> input.focus(), 80);
          return;
        }
      });

      form.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const q = (input.value || '').trim();
        if(!q) {
          wrap.classList.remove('open');
          input.value = '';
          return;
        }
        wrap.classList.remove('open');
        input.value = '';
        // For demo, we just filter local items by title/description
        applySearchLocal(q);
      });

      document.addEventListener('click', (ev) => {
        if(!wrap.contains(ev.target)) {
          wrap.classList.remove('open');
          input.value = '';
        }
      });

      document.addEventListener('keydown', (ev) => {
        if(ev.key === 'Escape') {
          wrap.classList.remove('open');
          input.value = '';
        }
      });
    }

    function applySearchLocal(q){
      const term = String(q||'').trim().toLowerCase();
      if(!term) return;
      // simple search: filter products by title/description, then render
      const matched = products.filter(p => (p.title + ' ' + p.description).toLowerCase().includes(term));
      // temporarily show the matched set (paging disabled for simplicity)
      const grid = document.getElementById('productGrid'); grid.innerHTML = '';
      document.getElementById('showingText').textContent = `Search results: ${matched.length} items`;
      const favSet = readFavorites();
      matched.slice(0, pageSize).forEach(p => {
        const card = document.createElement('div');
        card.className = 'product-card rounded-lg overflow-hidden';
        card.innerHTML = `<div class="relative overflow-hidden h-64">
            <img src="${p.image}" alt="${p.title}" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"></div>
          </div>
          <div class="p-4">
            <h3 class="font-medium mb-1 plunct" style="color:var(--black);">${p.title}</h3>
            <p class="plunct text-gray-600 text-sm mb-2" style="color:var(--black);">${p.description}</p>
            <div class="flex justify-between items-center">
              <span class="plunct font-bold" style="color:var(--black);">$${p.price.toLocaleString()}</span>
              <button class="snipcart-add-item inline-flex items-center px-3 py-2 rounded text-sm border border-transparent bg-amber-600 hover:bg-amber-700"
                data-item-id="${p.id}"
                data-item-name="${p.title}"
                data-item-price="${p.price}"
                data-item-url="/SHOP/"
                data-item-description="${p.description}"
                data-item-image="${p.image}">
                Add to cart
              </button>
            </div>
          </div>` ;
        grid.appendChild(card);
      });
      feather.replace();
      renderPagination(matched.length);
    }

    function initMobileSearch(){
      const mobileForm = document.getElementById('mobileSearchForm');
      const mobileInput = document.getElementById('mobileSearchInput');

      if(mobileForm){
        mobileForm.addEventListener('submit', (ev)=>{
          ev.preventDefault();
          const q = (mobileInput.value || '').trim();
          if(!q) return;
          mobileNav.style.display = 'none';
          document.body.classList.remove('mobile-search-open');
          mobileInput.value = '';
          setTimeout(()=> { applySearchLocal(q); }, 60);
        });
      }
    }

    function openMobileSearchAndFocus(){
      const mobileSearchBar = document.getElementById('mobileSearchBar');
      const mobileInput = document.getElementById('mobileSearchInput');
      if(mobileNav.style.display === 'none' || mobileNav.style.display === '') {
        mobileNav.style.display = 'block';
      }
      document.body.classList.add('mobile-search-open');
      setTimeout(()=> { if(mobileInput) mobileInput.focus(); }, 60);
    }

    /* --------------------------
       URL-driven filters (reads ?category=...&style=...)
    -------------------------- */
    window._urlAppliedFilters = { category: null, subtypes: [] };

    function applyUrlDrivenFiltersFromUrl(){
      const params = new URLSearchParams(window.location.search);
      const catParam = params.get('category');
      const styleParam = params.get('style'); // may be slug(s)

      if(catParam){
        const catNorm = catParam.trim().toLowerCase();
        const catInputs = Array.from(document.querySelectorAll('.filter-cat'));
        const matched = catInputs.find(i => i.value && i.value.toLowerCase() === catNorm);
        if(matched){ matched.checked = true; window._urlAppliedFilters.category = matched.value; openFilterSection('category-body'); }
      }

      if(styleParam){
        const styleParts = styleParam.split(',').map(s => s.trim()).filter(Boolean);
        for(const raw of styleParts){
          const label = slugToLabel(raw);
          if(label){
            const subInputs = Array.from(document.querySelectorAll('.filter-subtype'));
            const match = subInputs.find(i => i.value === label);
            if(match){ match.checked = true; window._urlAppliedFilters.subtypes.push(label); openFilterSection('subtype-body'); const tech = techniqueFromSubtype(label); if(tech){ const techInput = Array.from(document.querySelectorAll('.filter-tech')).find(i => i.value === tech); if(techInput){ techInput.checked = true; openFilterSection('feature-body'); }}}
            else {
              const decoded = decodeURIComponent(raw).replace(/[-_]+/g,' ').trim();
              const match2 = subInputs.find(i => i.value.toLowerCase() === decoded.toLowerCase());
              if(match2){ match2.checked = true; window._urlAppliedFilters.subtypes.push(match2.value); openFilterSection('subtype-body'); }
            }
          }
        }
      }

      if(window._urlAppliedFilters.category || (window._urlAppliedFilters.subtypes && window._urlAppliedFilters.subtypes.length)){
        readFiltersFromUI();
      }
    }

    function openFilterSection(sectionId){
      const el = document.getElementById(sectionId);
      if(!el) return;
      el.style.display = 'block';
      const btn = document.querySelector(`.filter-toggle[data-target="${sectionId}"]`);
      if(btn){ btn.querySelector('.chev')?.classList.add('open'); }
    }

    function updateAppliedFiltersPill(){
      const wrap = document.getElementById('appliedFiltersWrap');
      if(!wrap) return;
      const cat = window._urlAppliedFilters.category;
      const subs = window._urlAppliedFilters.subtypes || [];
      if(!cat && (!subs || subs.length === 0)){ wrap.innerHTML = ''; return; }
      const parts = [];
      if(cat) parts.push(cat);
      if(subs.length) parts.push(subs.join(' â€¢ '));
      const pillText = parts.join(' â€º ');
      wrap.innerHTML = `<span class="applied-pill" role="status" aria-live="polite">
        Filters applied: ${escapeHtml(pillText)}
        <button class="pill-close" title="Clear URL filters" aria-label="Clear filters">&times;</button>
      </span>`;
      const btn = wrap.querySelector('.pill-close');
      if(btn) btn.addEventListener('click', ()=> clearUrlDrivenFilters());
    }

    function clearUrlDrivenFilters(){
      if(window._urlAppliedFilters.category){
        const catInput = Array.from(document.querySelectorAll('.filter-cat')).find(i => i.value === window._urlAppliedFilters.category);
        if(catInput) catInput.checked = false;
      }
      (window._urlAppliedFilters.subtypes || []).forEach(lbl => {
        const inpt = Array.from(document.querySelectorAll('.filter-subtype')).find(i => i.value === lbl);
        if(inpt) inpt.checked = false;
      });
      const allTechInputs = Array.from(document.querySelectorAll('.filter-tech'));
      allTechInputs.forEach(i => { i.checked = false; });
      window._urlAppliedFilters = { category:null, subtypes:[] };
      readFiltersFromUI();
      currentPage = 1;
      renderProducts();
      const url = new URL(window.location.href);
      url.searchParams.delete('category');
      url.searchParams.delete('style');
      history.replaceState(null, '', url.toString());
    }

    // small helper
    function escapeHtml(s) {
      if(!s) return '';
      return String(s).replace(/[&<>"']/g, function (m) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
    }

    // Initialization on DOM ready
    document.addEventListener('DOMContentLoaded', ()=>{
      feather.replace();
      buildDemoProducts();
      applyUrlDrivenFiltersFromUrl();
      readFiltersFromUI();
      currentSort = document.getElementById('sortSelect').value || 'featured';
      renderProducts();
      initHeaderSearch();
      initMobileSearch();
    });
  </script>
</body>
</html>
